---
title: "prep_data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
# https://rdatatable.gitlab.io/data.table/articles/datatable-intro.html
# https://richarddmorey.github.io/BayesFactor/
rm(list = ls())
library(data.table); library(tidyverse)
```

```{r}
d0 <- fread("../data/raw/eNKqay_user_form.csv")
```

```{r}
d0[, n_distinct(user_id)]
d0[, unique(field)]
d0
```

```{r}
d0 <- d0[!grepl("test", user_id)]
```

```{r}
# get users who properly completed study
d0[field == "comments", .N, by = .(user_id)]
d0[field == "comments", .N, by = .(user_id)][N != 1]

users_complete <- d0[field == "comments", .N, by = .(user_id)][N == 1, user_id]
users_complete

d0 <- d0[user_id %in% users_complete]
d0
```


```{r}
# TODO: select more than just one variable (we have 6 questions, so select 6 variables/fields); use %in% to select/filter multiple fields not ==

cols <- c("attentioncheck1", "attentioncheck2", "politicalpref", "gender")
d1 <- d0[field %in% cols, .(user_id, field, response)][response != ""]
d1[, n_distinct(user_id)]
d1[, unique(response)] |> sort()
```

```{r atteniton check}
ac <- d1[field %in% c("politicalpref", "gender")]

ac[field == "politicalpref", acc := ifelse(response == "2_democratic", 1, 0)]
ac[field == "gender", acc := ifelse(response == "female", 1, 0)]

ac[, .(acc = mean(acc, na.rm = T)), by = user_id][, table(acc)]
attention <- ac[, .(attention = mean(acc, na.rm = T)), by = user_id]
attention

d1 <- left_join(d1, attention)
setDT(d1)
```


```{r}
d1[, news_eval := substr(response, 1, 1)]
d1[, news_eval := as.numeric(response_num)]
glimpse(d1)
```

```{r}
d2 <- fread("../data/raw/eNKqay_engagement.csv")
d2[, n_distinct(user_id)]
d2[, unique(user_id)]
d2[, n_distinct(entity_id)]
d2[, unique(entity_id)]

glimpse(d2)

d3 <- d2[, .(user_id, condition)][condition != "null"] |> distinct()

glimpse(d3)

d3[, condition := as.numeric(condition)]

d3[, unique(user_id)]


d4 <- left_join(d1, d3)

d4[, condition := condition - 1]  # recode condition to 0,1 foor model fitting

fwrite(d4, file = "../data/clean/merged_cleaned_data.csv")



```

