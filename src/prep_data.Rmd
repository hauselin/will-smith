---
title: "prep_data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
# https://rdatatable.gitlab.io/data.table/articles/datatable-intro.html
# https://richarddmorey.github.io/BayesFactor/
rm(list = ls())
library(data.table); library(tidyverse)
library(rgeolocate)
```

```{r}
d0 <- fread("../data/raw/ej3MkW_user_form.csv")
```

```{r}
d0[, n_distinct(user_id)]
d0[, unique(field)]
d0[, unique(user_id)]
d0
```

```{r}
d0 <- d0[!grepl("test", user_id)]
```

```{r}
# get users who properly completed study
d0[field == "comments", .N, by = .(user_id)]
d0[field == "comments", .N, by = .(user_id)][N != 1]

users_complete <- d0[field == "comments", .N, by = .(user_id)][N == 1, user_id]
users_complete

d0 <- d0[user_id %in% users_complete]
d0
```


```{r}
# select DVs
cols <- c("attentioncheck1", "attentioncheck2", "election-importance", "election-newsworthiness", "johnny-importance", "johnny-newsworthiness", "willsmith-importance", "willsmith-newsworthiness")
d1 <- d0[field %in% cols, .(user_id, field, response)]
d1[, n_distinct(user_id)]
d1[, unique(response)] |> sort()
```

```{r attention check}
ac <- d1[field %in% c("attentioncheck1", "attentioncheck2")]

ac[field == "attentioncheck1", acc := ifelse(response == "3_neither-agree-nor-disagree", 1, 0)]
ac[field == "attentioncheck2", acc := ifelse(response == "very-interested;extremely-interested", 1, 0)]

ac[, .(acc = mean(acc, na.rm = T)), by = user_id][, table(acc)]
attention <- ac[, .(attention = mean(acc, na.rm = T)), by = user_id]
attention

d1 <- left_join(d1, attention)
setDT(d1)
```


```{r}
d1[, news_eval := substr(response, 1, 1)]
d1[, news_eval := as.numeric(news_eval)]
glimpse(d1)
```

```{r}
d2 <- fread("../data/raw/ej3MkW_engagement.csv")
d2[, n_distinct(user_id)]
d2[, unique(user_id)]
d2[, n_distinct(entity_id)]
d2[, unique(entity_id)]

glimpse(d2)

d3 <- d2[, .(user_id, condition, ip_address)][condition != "null"] |> distinct()

glimpse(d3)

d3[, condition := as.numeric(condition)]

d3[, unique(user_id)]


d4 <- left_join(d1, d3)

d4[, condition := condition - 1]  # recode condition to 0,1 for model fitting

# remove non USA ip
file <- system.file("extdata","GeoLite2-Country.mmdb", package = "rgeolocate")
d4$country_codes <-  maxmind(d4$ip_address, file, "country_code")

d5 <- d4[country_codes == "US"]
d5[, unique(user_id)]

fwrite(d5, file = "../data/clean/merged_cleaned_data.csv")



```

